
@{
    ViewBag.Title = "Daily Sales | CJ Web Portal";
}
@section extra_style {
    <link href="~/Content/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/3.3.3/css/fixedColumns.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.1.9/css/fixedHeader.bootstrap4.min.css">
}
@section breadcrumb{
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item" aria-current="page"><a href="/">Transcom Digital</a></li>
        <li class="breadcrumb-item" aria-current="page">@Html.ActionLink("Daily Sales", ViewContext.RouteData.Values["Action"].ToString(), ViewContext.RouteData.Values["controller"].ToString())</li>
    </ol>
</nav>
}
    <div class="panel" style="margin: 10px auto;">
        <div class="panel-heading bg-gradient-primary">
            <a data-toggle="collapse" href="#collapse1" class="collapsed">
                <div class="panel-title" style="color:white">
                    <i class="fa fa-search"></i> Filter
                </div>
            </a>
        </div>
        <div id="collapse1" class="panel-collapse collapse bg-white p-3 shadow m-0 p-0">
            <div class="form-row">
                <div class="col-md-2 mb-3">
                    <label for="validationTooltip04">From Date</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                        </div>
                        <input type="text" class="form-control datepicker" id="fromDate" name="fromDate" value="@ViewBag.fromDate">
                        <div class="invalid-tooltip">
                            Please provide a Date.
                        </div>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="validationTooltip04">To Date</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                        </div>
                        <input type="text" class="form-control datepicker" id="toDate" name="toDate" value="@ViewBag.toDate">
                        <div class="invalid-tooltip">
                            Please provide a Date.
                        </div>
                    </div>
                </div>
                <!--AREA -->
                <div class="col-md-3 mb-3">
                    <label for="AREA">Area</label>
                    <div class="input-group">
                        <select class="selectpicker w-100" name="area" id="area" data-live-search="true">
                            <option value="All">All</option>
                            @{
                                if (ViewBag.areas != null)
                                {
                                    foreach (var area in ViewBag.areas)
                                    {
                                        <option value="@area.Id">@area.Text</option>
                                    }
                                }
                            }

                        </select>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="validationTooltip01">Zone </label>
                    <div class="input-group">
                        <select class="selectpicker w-100" name="zone" id="zone" data-live-search="true">
                            @*<option value="All">All</option>
                            @{
                                if (ViewBag.zones != null)
                                {
                                    foreach (var zone in ViewBag.zones)
                                    {
                                        <option value="@zone.Id">@zone.Text</option>
                                    }
                                }
                            }*@
                        </select>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="validationTooltip03">Outlet</label>
                    <div class="input-group">
                        <select class="selectpicker w-100" name="outlet" id="outlet" data-live-search="true">
                            @*<option value="All">All</option>
                            @{
                                if (ViewBag.outlet != null)
                                {
                                    foreach (var outlet in ViewBag.outlet)
                                    {
                                        <option value="@outlet.Id">@outlet.Text</option>
                                    }
                                }
                            }*@
                        </select>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="validationTooltip03">PG</label>
                    <div class="input-group">
                        <select class="selectpicker w-100" name="pg" id="pg" data-live-search="true">
                            <option value="">All</option>
                            @{
                                if (ViewBag.pg != null)
                                {
                                    foreach (var pg in ViewBag.pg)
                                    {
                                        <option value="@pg.Id">@pg.Text</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="validationTooltip03">Brand</label>
                    <div class="input-group">
                        <select class="selectpicker w-100" name="brand" id="brand" data-live-search="true">
                            <option value="">All</option>
                            @{
                                if (ViewBag.brand != null)
                                {
                                    foreach (var brand in ViewBag.brand)
                                    {
                                        <option value="@brand.Id">@brand.Text</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <label for="validationTooltip03">Channel</label>
                    <div class="input-group">
                        <select class="selectpicker w-100" name="channel" id="channel" data-live-search="true">
                            <option value="">All</option>
                            @{
                                if (ViewBag.channel != null)
                                {
                                    foreach (var channel in ViewBag.channel)
                                    {
                                        <option value="@channel.Id">@channel.Text</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="validationTooltip03" class="text-white">Z</label>
                    <div class="input-group">
                        <button class="btn btn-primary" id="filter" type="submit"><i class="fa fa-search"></i> Search <i class="fas fa-spinner fa-pulse" id="loadingIcon"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <!-- Card Body -->
                    <div class="card-body">
                        <table id="dataTable" class="table table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>
                                        MAG-Brand
                                    </th>
                                    <th>
                                        Target Qty
                                    </th>

                                    <th>
                                        Sales Qty
                                    </th>
                                    <th>
                                        Qty %
                                    </th>
                                    <th>
                                        Target Value
                                    </th>
                                    <th>
                                        Net Sale
                                    </th>
                                    <th>
                                        Val %
                                    </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th style="text-align:right;">Page Total:<br />Total:</th>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
@section extra_script {
    <!-- Page level plugins -->
    <script src="~/Content/datatables/jquery.dataTables.min.js"></script>
    <script src="~/Content/datatables/dataTables.bootstrap4.min.js"></script>
    <!-- Page level custom scripts -->
    <script src="~/Content/datatables/datatables-custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/3.3.3/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.1.9/js/dataTables.fixedHeader.min.js"></script>
    <script>
        function loadtable() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            var area = $('#area option:selected').text();
            var zone = $('#zone option:selected').text();
            var channel = $('#channel option:selected').text();
            var outlet = $('#outlet').val();
            var pg = $('#pg option:selected').text();
            var brand = $('#brand option:selected').text();
            if ($.fn.dataTable.isDataTable('#dataTable')) {
                table.destroy();
            }
            table = $('#dataTable').DataTable({
                "scrollX": true,
                "responsive": false,
                "pagingType": "full_numbers",
                "pageLength": 10,
                scrollCollapse: true,
                 fixedColumns:true,
                "language": {
                    paginate: {
                        next: '<i class="fa fa-fw fa-chevron-right">',
                        previous: '<i class="fa fa-fw fa-chevron-left">',
                        first: '<i class="fa fa-angle-double-left"></i>',
                        last: '<i class="fa fa-angle-double-right"></i>'
                    },
                },
                "initComplete": function (settings, json) {
                    closeloadermodal();
                    $("#loadingIcon").addClass("d-none");
                },
                "ajax": {
                    "url": "@Url.Action("loaddata")",
                    "type": "GET",
                    "data": {fromDate:fromDate, toDate:toDate,area:area,zone:zone,outlet:outlet,pg:pg,brand:brand,channel:channel},
                    "datatype": "json",
                },
                "columns": [
              { "data": "MAGName", "name": "MAGName"},
              { "data": "TargetQty", "name": "TargetQty"},
              { "data": "SalesQty", "name": "SalesQty"},
              { "data": "QtyPer", "name": "QtyPer"},
              { "data": "TargetValue", "name": "TargetValue"},
              { "data": "NetSale", "name": "NetSale"},
              { "data": "ValPer", "name": "ValPer"},

                ],
                "columnDefs": [
                  { className: "text-right", "targets": [1, 2, 3, 4, 5, 6] },
                  { className: "text-nowrap", "targets": [0] }
                ],
               
                "footerCallback": function (row, data, start, end, display) {
                    var api = this.api(), data;

                    // Remove the formatting to get integer data for summation
                    var intVal = function (i) {
                        return typeof i === 'string' ?
                            i.replace(/[\$,]/g, '') * 1 :
                            typeof i === 'number' ?
                            i : 0;
                    };
                    //For targate
                    // Total over all pages
                    targetTotal = api
                        .column(4)
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Total over this page
                    targetPageTotal = api
                        .column(4, { page: 'current' })
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Update footer
                    $(api.column(4).footer()).html(
                        '৳' + targetPageTotal + '<br> ৳' + targetTotal + ''
                    );

                    //
                    // Total over all pages
                    tqTotal = api
                        .column(1)
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Total over this page
                    tqPageTotal = api
                        .column(1, { page: 'current' })
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Update footer
                    $(api.column(1).footer()).html(
                       tqPageTotal + '<br>' + tqTotal + ''
                    );


                    // Total over all pages
                    sqTotal = api
                        .column(2)
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Total over this page
                    sqPageTotal = api
                        .column(2, { page: 'current' })
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Update footer
                    $(api.column(2).footer()).html(
                       sqPageTotal + '<br>' + sqTotal + ''
                    );


                    // Total over all pages
                    nsTotal = api
                        .column(5)
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Total over this page
                    nsPageTotal = api
                        .column(5, { page: 'current' })
                        .data()
                        .reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Update footer
                    $(api.column(5).footer()).html(
                      '৳' + nsPageTotal + '<br> ৳' + nsTotal + ''
                    );
                    let valPer = 0;
                    
                    // Update footer
                    if(targetTotal>0){
                        valPer = nsTotal / targetTotal * 100;
                    }

                    let thisPageValPer = 0;
                    if (targetPageTotal>0) {
                        thisPageValPer = nsPageTotal / targetPageTotal * 100;
                    }
                    $(api.column(6).footer()).html(            
                       Math.round(thisPageValPer, 0) + '<br>' + Math.round(valPer, 0)
                    );


                    let thisPageQtyPer = 0;
                    if (tqPageTotal > 0) {
                        thisPageQtyPer = sqPageTotal / tqPageTotal * 100;
                    }
                    let thisQtyPer = 0;
                    if (tqTotal > 0) {
                        thisQtyPer = sqTotal / tqTotal * 100;
                    }
                    $(api.column(3).footer()).html(            
                       Math.round(thisPageQtyPer, 0) + '<br>' + Math.round(thisQtyPer, 0)
                    );
                }
            });
        };
        $(function () {
            $('select').selectpicker();
            loadermodal();
            loadtable();
            $('.datepicker').datepicker();
            $("#filter").click(function () {
                $("#loadingIcon").removeClass("d-none");
                loadermodal();
                loadtable();
            });
        });
    </script>
    <!-- Bootstrap DatePicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/js/bootstrap-datepicker.js" type="text/javascript"></script>
    <!-- Bootstrap DatePicker -->
    <script type="text/javascript">
        $(function () {
            $('.datepicker').datepicker({
                changeMonth: true,
                changeYear: true,
                format: "M/DD/YYYY",
            });
        });
        function loadOutlet() {
            $("#outlet").find('option').remove();
            $('#outlet').selectpicker('refresh');
            var zone = $('#zone option:selected').val();
            $.ajax({
                type: "GET",
                url: '@Url.Action("loadOutlet", "Common")',
                data: { zone: zone },
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $('#outlet').append($('<option>', {
                        value: 'All',
                        text: 'All'
                    }));
                    $('#outlet').selectpicker('refresh');
                    for (var i = 0; i < data.length; i++) {
                        $('#outlet').append($('<option>', {
                            value: data[i].Id,
                            text: data[i].Text
                        }));
                        $('#outlet').selectpicker('refresh');
                    }

                },
                error: function () {
                    alert("Error while inserting data");
                }
            });
        }
    //Area dropdown init
        $("#area").change(function () {
            $("#zone").find('option').remove();
            $('#zone').selectpicker('refresh');
            var valueSelected = this.value;
            $.ajax({
                type: "GET",
                url: '@Url.Action("loadZones", "Common")',
                data: { area: valueSelected },
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $('#zone').append($('<option>', {
                        value: 'All',
                        text: 'All'
                    }));
                    $("#zone option[value='All']").prop('selected', true);
                    $('#zone').selectpicker('refresh');
                    for (var i = 0; i < data.length; i++) {
                        //s += '<option value="' + data[i].MarketGroupCode + '">' + data[i].MarketGroupDesc + '</option>';
                        $('#zone').append($('<option>', {
                            value: data[i].Id,
                            text: data[i].Text
                        }));
                        $('#zone').selectpicker('refresh');
                    }
                    loadOutlet();
                },
                error: function () {
                    alert("Error while inserting data");
                }
            });
            return false;
        });


     $("#zone").change(function () {
        loadOutlet();
        return false;
    });


      //Customer dropdown init
    $("#custType").change(function () {
        var selectedType = this.value;
        var selectedZone = $("#zone option:selected").val();
        $.ajax({
            type: "GET",
            url: '@Url.Action("loadCust")',
            data: { type: selectedType, zone: selectedZone },
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $("#cust").find('option').remove();
                $('#cust').selectpicker('refresh');
                $('#cust').append($('<option>', {
                    value: 'All',
                    text: 'All'
                }));
                $('#cust').selectpicker('refresh');
                for (var i = 0; i < data.length; i++) {
                    $('#cust').append($('<option>', {
                        value: data[i].Id,
                        text: data[i].Text
                    }));
                    $('#cust').selectpicker('refresh');
                }

            },
            error: function () {
                alert("Error while inserting data");
            }
        });
        return false;
    });
    </script>
}




